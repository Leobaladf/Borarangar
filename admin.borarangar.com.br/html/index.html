<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Admin BoraRangar</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-slate-100 min-h-screen">
    <header class="bg-white shadow-md">
        <div class="max-w-7xl mx-auto p-4 flex justify-between items-center">
            <h1 class="text-2xl font-bold text-slate-800">Painel de Controle Super Admin</h1>
            <button id="logout-btn" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg">Sair</button>
        </div>
    </header>

    <main class="max-w-7xl mx-auto p-4 md:p-8">

        <section class="mb-8 grid grid-cols-1 sm:grid-cols-3 gap-4">
            <div class="bg-white p-6 rounded-lg shadow-md text-center">
                <h2 class="text-sm font-semibold text-slate-500 uppercase">Restaurantes Cadastrados</h2>
                <p id="total-restaurantes" class="text-4xl font-bold text-slate-800 mt-2">--</p>
            </div>
            </section>

        <section class="mb-8 grid grid-cols-2 md:grid-cols-4 gap-4 md:gap-6">
            <a href="/gerenciar-restaurantes.html" class="bg-white p-6 rounded-lg shadow-md hover:shadow-xl hover:-translate-y-1 transition-all flex flex-col items-center text-center">
                <div class="bg-green-100 p-4 rounded-full mb-4"><svg class="w-8 h-8 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path></svg></div>
                <h2 class="font-bold text-slate-800">Gerenciar Restaurantes</h2>
            </a>
            <button id="open-add-user-modal" class="bg-white p-6 rounded-lg shadow-md hover:shadow-xl hover:-translate-y-1 transition-all flex flex-col items-center text-center">
                 <div class="bg-blue-100 p-4 rounded-full mb-4"><svg class="w-8 h-8 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z"></path></svg></div>
                <h2 class="font-bold text-slate-800">Criar Usuário Lojista</h2>
            </button>
            <a href="/usuarios.html" class="bg-white p-6 rounded-lg shadow-md hover:shadow-xl hover:-translate-y-1 transition-all flex flex-col items-center text-center">
                <div class="bg-yellow-100 p-4 rounded-full mb-4"><svg class="w-8 h-8 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"></path></svg></div>
                <h2 class="font-bold text-slate-800">Ver/Gerenciar Usuários</h2>
            </a>
            <a href="/clientes-admin.html" class="bg-white p-6 rounded-lg shadow-md hover:shadow-xl hover:-translate-y-1 transition-all flex flex-col items-center text-center">
                <div class="bg-purple-100 p-4 rounded-full mb-4"><svg class="w-8 h-8 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg></div>
                <h2 class="font-bold text-slate-800">Ver Clientes Finais</h2>
            </a>
        </section>

        </main>

    <div id="add-restaurant-modal" class="hidden fixed inset-0 bg-black/60 backdrop-blur-sm z-50 flex items-center justify-center p-4">
        <div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-lg">
            <h2 class="text-xl font-bold text-slate-700 mb-4">Adicionar Novo Restaurante</h2>
            <form id="add-restaurant-form">
                <div class="mb-4">
                    <label for="nome" class="block text-sm font-medium text-slate-600">Nome do Restaurante</label>
                    <input type="text" id="nome" name="nome" required class="mt-1 block w-full p-2 border border-slate-300 rounded-md shadow-sm">
                </div>
                <div class="mb-4">
                    <label for="subdominio" class="block text-sm font-medium text-slate-600">Subdomínio</label>
                    <input type="text" id="subdominio" name="subdominio" required class="mt-1 block w-full p-2 border border-slate-300 rounded-md shadow-sm" placeholder="ex: nomedaloja (letras minúsculas, sem espaços)">
                     <p class="text-xs text-slate-500 mt-1">Será usado como nomedaloja.borarangar.com.br</p>
                </div>
                 <p id="restaurant-form-message" class="text-sm h-5 mb-4"></p>
                <div class="flex justify-end gap-4 mt-6">
                    <button type="button" class="btn-close-modal bg-slate-200 py-2 px-4 rounded-lg">Cancelar</button>
                    <button type="submit" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg">Adicionar Restaurante</button>
                </div>
            </form>
        </div>
    </div>

    <div id="add-user-modal" class="hidden fixed inset-0 bg-black/60 backdrop-blur-sm z-50 flex items-center justify-center p-4">
        <div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-lg">
            <h2 class="text-xl font-bold text-slate-700 mb-4">Criar Novo Usuário para Restaurante</h2>
            <form id="add-user-form">
                 <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="user-restaurante-id" class="block text-sm font-medium text-slate-600">ID do Restaurante</label>
                        <input type="number" id="user-restaurante-id" name="restaurante_id" required class="mt-1 block w-full p-2 border border-slate-300 rounded-md shadow-sm">
                        <p class="text-xs text-slate-500 mt-1">Veja o ID na <a href="/gerenciar-restaurantes.html" class="text-blue-600 underline">lista de restaurantes</a>.</p> </div>
                    <div>
                        <label for="user-nome" class="block text-sm font-medium text-slate-600">Nome do Usuário</label>
                        <input type="text" id="user-nome" name="nome" required class="mt-1 block w-full p-2 border border-slate-300 rounded-md shadow-sm">
                    </div>
                    <div>
                        <label for="user-email" class="block text-sm font-medium text-slate-600">E-mail</label>
                        <input type="email" id="user-email" name="email" required class="mt-1 block w-full p-2 border border-slate-300 rounded-md shadow-sm">
                    </div>
                    <div>
                        <label for="user-senha" class="block text-sm font-medium text-slate-600">Senha</label>
                        <input type="password" id="user-senha" name="senha" required class="mt-1 block w-full p-2 border border-slate-300 rounded-md shadow-sm">
                    </div>
                    <div class="md:col-span-2">
                        <label for="user-role" class="block text-sm font-medium text-slate-600">Cargo (Role)</label>
                        <select id="user-role" name="role" class="mt-1 block w-full p-2 border border-slate-300 rounded-md shadow-sm bg-white">
                            <option value="dono">Dono (Acesso total ao painel do restaurante)</option>
                            <option value="gerente">Gerente</option>
                            <option value="funcionario">Funcionário (Pode gerenciar pedidos)</option>
                            <option value="caixa">Caixa</option>
                            <option value="entregador">Entregador</option>
                        </select>
                    </div>
                 </div>
                <p id="user-form-message" class="text-sm h-5 mt-4"></p>
                <div class="flex justify-end gap-4 mt-6">
                    <button type="button" class="btn-close-modal bg-slate-200 py-2 px-4 rounded-lg">Cancelar</button>
                    <button type="submit" class="w-full md:w-auto bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg">Criar Usuário</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // Referências aos elementos do HTML
            const totalRestaurantesEl = document.getElementById('total-restaurantes');
            const logoutBtn = document.getElementById('logout-btn');

            // Modais e Formulários (Mantém os de Adicionar)
            const addRestaurantModal = document.getElementById('add-restaurant-modal');
            const addUserModal = document.getElementById('add-user-modal');
            const addRestaurantForm = document.getElementById('add-restaurant-form');
            const addUserForm = document.getElementById('add-user-form');
            const restaurantFormMessage = document.getElementById('restaurant-form-message');
            const userFormMessage = document.getElementById('user-form-message');

            // Botões que abrem/fecham modais
            // const openAddRestaurantBtn = document.getElementById('open-add-restaurant-modal'); // Não é mais botão, é link
            const openAddUserBtn = document.getElementById('open-add-user-modal');
            const closeButtons = document.querySelectorAll('.btn-close-modal');

            // --- FUNÇÃO DE VERIFICAÇÃO DE SESSÃO E CONTAGEM ---
            async function checkSessionAndCount() {
                try {
                    const response = await fetch('/api.php'); // API exige login
                    if (response.status === 403) { window.location.href = '/login.html'; return; }
                    if (!response.ok) { throw new Error('Falha ao buscar dados.'); }
                    const restaurantes = await response.json();
                    // Atualiza o KPI
                    totalRestaurantesEl.textContent = restaurantes.length;
                    // Não precisa mais renderizar a lista aqui
                } catch (error) {
                    console.error("Erro no checkSessionAndCount:", error);
                    totalRestaurantesEl.textContent = "Erro"; // Indica erro no KPI
                    // Poderia mostrar uma mensagem de erro mais visível se desejado
                }
            }

            // --- FUNÇÕES PARA ABRIR/FECHAR MODAIS ---
            function openModal(modalElement) { if (modalElement) modalElement.classList.remove('hidden'); }
            function closeModal(modalElement) { if (modalElement) modalElement.classList.add('hidden'); }

            // --- OUVINTES DE EVENTOS (LISTENERS) ---

            // Botão que abre o modal de Adicionar Usuário
            openAddUserBtn.addEventListener('click', () => openModal(addUserModal));

            // Botões que fecham TODOS os modais
            closeButtons.forEach(button => {
                button.addEventListener('click', () => {
                    closeModal(addRestaurantModal);
                    closeModal(addUserModal);
                    // closeModal(editModal); // Modal de edição foi removido
                });
            });

            // Formulário Adicionar Restaurante (Permanece, caso queira manter o modal)
            addRestaurantForm.addEventListener('submit', async (e) => { 
                e.preventDefault();
                restaurantFormMessage.textContent = 'Cadastrando...';
                restaurantFormMessage.className = 'text-sm h-5 mb-4 text-blue-600';
                const formData = new FormData(addRestaurantForm);
                try {
                    const response = await fetch('/api.php', { method: 'POST', body: formData });
                    const data = await response.json();
                    if (response.ok && data.status === 'success') {
                        restaurantFormMessage.textContent = 'Restaurante cadastrado!';
                        restaurantFormMessage.className = 'text-sm h-5 mb-4 text-green-600';
                        addRestaurantForm.reset(); 
                        checkSessionAndCount(); // Apenas atualiza a contagem
                        setTimeout(() => { 
                           closeModal(addRestaurantModal);
                           restaurantFormMessage.textContent = ''; 
                        }, 1500);
                    } else { throw new Error(data.message || 'Erro desconhecido.'); }
                } catch (error) {
                    restaurantFormMessage.textContent = `Erro: ${error.message}`;
                    restaurantFormMessage.className = 'text-sm h-5 mb-4 text-red-600';
                }
            });

            // Formulário Adicionar Usuário (Permanece)
            addUserForm.addEventListener('submit', async (e) => { 
                e.preventDefault();
                userFormMessage.textContent = 'Criando usuário...';
                userFormMessage.className = 'text-sm h-5 mt-4 text-blue-600';
                const formData = new FormData(addUserForm);
                formData.append('action', 'registrar');
                try {
                    const response = await fetch('/usuario_api.php', { method: 'POST', body: formData });
                    const data = await response.json();
                    if (response.ok && data.status === 'success') {
                        userFormMessage.textContent = `Usuário criado com sucesso!`;
                        userFormMessage.className = 'text-sm h-5 mt-4 text-green-600';
                        addUserForm.reset();
                         setTimeout(() => { 
                           closeModal(addUserModal);
                           userFormMessage.textContent = ''; 
                        }, 1500);
                    } else { throw new Error(data.message || 'Erro desconhecido.'); }
                } catch (error) {
                    userFormMessage.textContent = `Erro: ${error.message}`;
                    userFormMessage.className = 'text-sm h-5 mt-4 text-red-600';
                }
            });

            // LISTENERS DA LISTA E MODAL DE EDIÇÃO FORAM REMOVIDOS

            // Botão Sair
            logoutBtn.addEventListener('click', () => { window.location.href = '/login.html'; });

            // --- INICIALIZAÇÃO ---
            checkSessionAndCount(); // Chama a função para verificar sessão e contar restaurantes
        });
    </script>
</body>
</html>
