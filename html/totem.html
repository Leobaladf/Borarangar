<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BoraRangar - Autoatendimento</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #e51b24; border-radius: 10px; }
        .loader { border-top-color: #e51b24; animation: spinner 1.5s linear infinite; }
        @keyframes spinner { to { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-slate-100 h-screen overflow-y-auto md:overflow-hidden">

    <div id="loading-screen" class="fixed inset-0 bg-white flex flex-col items-center justify-center z-50 p-8">
        <div class="loader ease-linear rounded-full border-8 border-t-8 border-gray-200 h-32 w-32 mb-4"></div>
        <h2 id="loading-text" class="text-center text-slate-700 text-xl font-semibold">Carregando totem...</h2>
    </div>

    <div id="welcome-screen" class="hidden fixed inset-0 bg-black/80 backdrop-blur-sm flex-col items-center justify-center z-40 cursor-pointer p-4">
        <h1 id="welcome-restaurant-name" class="text-4xl md:text-6xl font-extrabold text-white mb-4 text-center"></h1>
        <p class="text-xl md:text-2xl text-slate-300 mb-10 text-center">Toque na tela para come√ßar seu pedido</p>
    </div>

    <div id="main-content" class="flex-col lg:flex-row h-screen opacity-0" style="display: none;">
        <aside class="w-full lg:w-24 bg-white flex flex-row lg:flex-col items-center p-2 lg:py-6 shadow-lg overflow-x-auto">
            <nav id="category-menu" class="flex flex-row lg:flex-col gap-2 w-full"></nav>
        </aside>
        <main class="flex-1 p-4 md:p-8 overflow-y-auto">
            <header class="mb-6 flex justify-between items-center">
                <h2 id="category-title" class="text-3xl md:text-4xl font-bold text-slate-800">Destaques</h2>
            </header>
            <div id="cardapio-grid" class="grid grid-cols-2 md:grid-cols-3 xl:grid-cols-4 2xl:grid-cols-5 gap-4 md:gap-6"></div>
        </main>
        <aside class="w-full lg:w-96 bg-white p-4 md:p-6 flex flex-col shadow-xl border-t-2 lg:border-l-2">
            <div class="flex-shrink-0">
                <h2 class="text-2xl font-bold text-slate-800 mb-4">Seu Pedido</h2>
            </div>
            <div id="carrinho-itens" class="flex-grow overflow-y-auto -mr-2 pr-2">
                <div id="carrinho-vazio" class="h-full flex flex-col items-center justify-center text-slate-400">
                    <span class="text-6xl">üõí</span>
                    <p class="mt-4 font-semibold">Seu carrinho est√° vazio</p>
                </div>
            </div>
            <div class="flex-shrink-0 border-t pt-4">
                <div class="flex justify-between font-bold text-slate-900 mb-4">
                    <span class="text-2xl">Total</span>
                    <span id="total-carrinho" class="text-2xl">R$ 0,00</span>
                </div>
                <button id="finalizar-pedido" class="w-full bg-red-600 text-white font-bold py-4 rounded-xl text-lg disabled:bg-slate-300" disabled>
                    Finalizar Pedido
                </button>
            </div>
        </aside>
    </div>
    
    <div id="modal-confirmacao" class="hidden fixed inset-0 bg-black/60 z-30 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl p-8 max-w-lg mx-4 text-center shadow-2xl w-full">
            <h2 class="text-3xl font-bold text-slate-800 mb-2">Confirme seu Pedido</h2>
            <p class="text-slate-500 mb-6">Confira os itens e informe seu nome para finalizar.</p>
            <div id="confirm-order-summary" class="max-h-48 overflow-y-auto my-4 border-t border-b py-4 space-y-2"></div>
            <form id="confirmation-form">
                <input type="text" id="confirm-nome" placeholder="Seu nome (para chamar a senha)" class="w-full p-4 border-2 rounded-lg text-lg" required>
                <div class="grid grid-cols-2 gap-4 mt-6">
                    <button type="button" id="voltar-carrinho-btn" class="w-full bg-slate-200 font-bold py-3 rounded-xl text-lg">Voltar</button>
                    <button type="submit" id="confirmar-pedido-btn" class="w-full bg-green-500 text-white font-bold py-3 rounded-xl text-lg">Confirmar Pedido</button>
                </div>
            </form>
        </div>
    </div>
    <div id="modal-sucesso" class="hidden fixed inset-0 bg-black/60 z-40 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl p-10 max-w-md mx-4 text-center shadow-2xl">
            <span class="text-8xl mb-4">‚úÖ</span>
            <h2 class="text-3xl font-bold text-slate-800 mb-2">Pedido Enviado!</h2>
            <p class="text-lg text-slate-500 mb-6">Aguarde seu pedido ser chamado pelo nome.</p>
            <p id="senha-pedido" class="text-6xl font-mono font-extrabold text-red-600 my-4"></p>
            <button id="fechar-modal" class="bg-slate-800 text-white font-bold py-3 px-8 rounded-lg w-full text-lg">
                Novo Pedido
            </button>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const welcomeScreen = document.getElementById('welcome-screen');
            const welcomeRestaurantName = document.getElementById('welcome-restaurant-name');
            const mainContent = document.getElementById('main-content');
            const loadingScreen = document.getElementById('loading-screen');
            const loadingText = document.getElementById('loading-text');
            const categoryMenu = document.getElementById('category-menu');
            const categoryTitle = document.getElementById('category-title');
            const cardapioGrid = document.getElementById('cardapio-grid');
            const carrinhoItensEl = document.getElementById('carrinho-itens');
            const carrinhoVazioEl = document.getElementById('carrinho-vazio');
            const totalCarrinhoEl = document.getElementById('total-carrinho');
            const finalizarPedidoBtn = document.getElementById('finalizar-pedido');
            const modalConfirmacao = document.getElementById('modal-confirmacao');
            const confirmationForm = document.getElementById('confirmation-form');
            const confirmNomeInput = document.getElementById('confirm-nome');
            const confirmOrderSummary = document.getElementById('confirm-order-summary');
            const voltarCarrinhoBtn = document.getElementById('voltar-carrinho-btn');
            const modalSucessoEl = document.getElementById('modal-sucesso');
            const fecharModalBtn = document.getElementById('fechar-modal');
            const senhaPedidoEl = document.getElementById('senha-pedido');
            
            let cardapio = [];
            let categorias = [];
            let carrinho = [];
            let restaurante = null;

            async function initTotem() {
                try {
                    // ETAPA 1: Descobre qual restaurante carregar com base no subdom√≠nio
                    loadingText.textContent = 'Identificando restaurante...';
                    const restauranteResponse = await fetch('restaurante_api.php');
                    if (!restauranteResponse.ok) throw new Error('Restaurante n√£o encontrado.');
                    restaurante = await restauranteResponse.json();
                    
                    document.title = `${restaurante.nome} - Autoatendimento`;
                    welcomeRestaurantName.textContent = `Bem-vindo ao ${restaurante.nome}!`;

                    // ETAPA 2: Com o ID, busca categorias e card√°pio
                    loadingText.textContent = 'Carregando card√°pio...';
                    const [categoriasResponse, cardapioResponse] = await Promise.all([
                        fetch('categorias_api.php'),
                        fetch(`cardapio_api.php?restaurante_id=${restaurante.id}`)
                    ]);
                    if (!categoriasResponse.ok || !cardapioResponse.ok) throw new Error("Falha ao carregar o card√°pio.");
                    
                    categorias = await categoriasResponse.json();
                    cardapio = await cardapioResponse.json();
                    
                    renderizarCategorias();
                    renderizarCardapio(categorias[0]?.id || '*');
                    
                    loadingScreen.classList.add('hidden');
                    welcomeScreen.classList.remove('hidden');
                    welcomeScreen.classList.add('flex');

                } catch (error) {
                    console.error("Erro na inicializa√ß√£o do totem:", error);
                    loadingText.innerHTML = `<h2 class="text-red-600">${error.message}</h2><p>Verifique se o subdom√≠nio est√° correto.</p>`;
                }
            }
            
            function renderizarCategorias() {
                categoryMenu.innerHTML = '';
                categorias.forEach(cat => {
                    categoryMenu.innerHTML += `<button data-filter="${cat.id}" class="category-btn flex-shrink-0 flex flex-col items-center gap-1 p-2 rounded-lg w-20 hover:bg-slate-100"><span class="text-3xl">${cat.icone}</span><span class="text-xs font-semibold text-center">${cat.nome}</span></button>`;
                });
                const firstCategory = categoryMenu.querySelector('.category-btn');
                if(firstCategory) {
                    firstCategory.classList.add('bg-red-100', 'text-red-600');
                    categoryTitle.textContent = categorias.find(c => c.id === firstCategory.dataset.filter)?.nome || 'Destaques';
                }
            }

            function renderizarCardapio(filter = '*') {
                cardapioGrid.innerHTML = '';
                const produtosFiltrados = filter === '*' ? cardapio : cardapio.filter(p => p.categoria === filter);
                produtosFiltrados.forEach(produto => {
                    cardapioGrid.innerHTML += `<div class="bg-white rounded-2xl shadow-md overflow-hidden transform hover:-translate-y-1 cursor-pointer product-card flex flex-col" data-id="${produto.id}"><div class="h-32 md:h-40"><img src="https://placehold.co/500x500/fecaca/991b1b?text=${encodeURIComponent(produto.nome)}" alt="${produto.nome}" class="w-full h-full object-cover"></div><div class="p-2 md:p-4 flex-grow flex flex-col justify-center"><h3 class="font-bold text-sm md:text-lg text-slate-800 text-center">${produto.nome}</h3></div></div>`;
                });
            }
            
            function renderizarCarrinho() {
                let subtotal = 0;
                if (carrinho.length === 0) {
                    carrinhoItensEl.innerHTML = '';
                    carrinhoVazioEl.classList.remove('hidden');
                    finalizarPedidoBtn.disabled = true;
                } else {
                    carrinhoVazioEl.classList.add('hidden');
                    finalizarPedidoBtn.disabled = false;
                    carrinhoItensEl.innerHTML = '';
                    carrinho.forEach(item => {
                        subtotal += item.preco * item.quantidade;
                        carrinhoItensEl.innerHTML += `<div class="flex items-center gap-4 mb-4"><div class="flex-grow"><p class="font-bold text-sm">${item.nome}</p><p class="text-red-600 font-semibold">R$ ${item.preco.toFixed(2)}</p></div><div class="flex items-center gap-2"><button data-id="${item.id}" class="remove-btn w-8 h-8 rounded-full bg-slate-200 font-bold">-</button><span class="font-bold w-6 text-center">${item.quantidade}</span><button data-id="${item.id}" class="add-btn-carrinho w-8 h-8 rounded-full bg-slate-200 font-bold">+</button></div></div>`;
                    });
                }
                totalCarrinhoEl.textContent = `R$ ${subtotal.toFixed(2)}`;
            }

            function adicionarAoCarrinho(produtoId) {
                const produto = cardapio.find(p => p.id == produtoId);
                if (!produto) return;
                const itemNoCarrinho = carrinho.find(item => item.id === produto.id);
                if (itemNoCarrinho) itemNoCarrinho.quantidade++;
                else carrinho.push({ ...produto, quantidade: 1 });
                renderizarCarrinho();
            }
            
            function removerDoCarrinho(produtoId) {
                const itemIndex = carrinho.findIndex(item => item.id == produtoId);
                if (itemIndex > -1) {
                    carrinho[itemIndex].quantidade--;
                    if (carrinho[itemIndex].quantidade <= 0) carrinho.splice(itemIndex, 1);
                }
                renderizarCarrinho();
            }

            async function enviarPedido() {
                 if (carrinho.length === 0 || !restaurante) return;
                 document.getElementById('confirmar-pedido-btn').disabled = true;
                 const payload = {
                    restaurante_id: restaurante.id,
                    cliente: { nome: confirmNomeInput.value || "Cliente Totem" },
                    carrinho: carrinho.map(item => ({ nome: item.nome, quantidade: item.quantidade, preco: item.preco }))
                 };
                 try {
                    const response = await fetch('pedidos_api.php', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                    const data = await response.json();
                    if (!response.ok) throw new Error(data.message || "Erro no servidor");
                    
                    modalConfirmacao.classList.add('hidden');
                    senhaPedidoEl.textContent = `#${data.id}`;
                    modalSucessoEl.classList.remove('hidden');
                 } catch (error) {
                    alert("N√£o foi poss√≠vel registrar o pedido. Tente novamente.");
                 } finally {
                    document.getElementById('confirmar-pedido-btn').disabled = false;
                 }
            }
            
            function showConfirmationModal() {
                confirmOrderSummary.innerHTML = '';
                carrinho.forEach(item => {
                    confirmOrderSummary.innerHTML += `<div class="flex justify-between"><span class="text-slate-600">${item.quantidade}x ${item.nome}</span><span class="font-semibold">R$ ${(item.preco * item.quantidade).toFixed(2)}</span></div>`;
                });
                modalConfirmacao.classList.remove('hidden');
            }
            
            welcomeScreen.addEventListener('click', () => {
                welcomeScreen.style.display = 'none';
                mainContent.style.display = 'flex';
                mainContent.classList.remove('opacity-0');
            });
            
            finalizarPedidoBtn.addEventListener('click', () => {
                if (carrinho.length > 0) showConfirmationModal();
            });

            voltarCarrinhoBtn.addEventListener('click', () => modalConfirmacao.classList.add('hidden'));
            confirmationForm.addEventListener('submit', (e) => { e.preventDefault(); enviarPedido(); });
            
            categoryMenu.addEventListener('click', (e) => {
                const categoryBtn = e.target.closest('.category-btn');
                if (!categoryBtn) return;
                categoryMenu.querySelector('.bg-red-100')?.classList.remove('bg-red-100', 'text-red-600');
                categoryBtn.classList.add('bg-red-100', 'text-red-600');
                const filter = categoryBtn.dataset.filter;
                categoryTitle.textContent = categorias.find(c => c.id === filter)?.nome || 'Destaques';
                renderizarCardapio(filter);
            });
            
            cardapioGrid.addEventListener('click', (e) => {
                const productCard = e.target.closest('.product-card');
                if(productCard) adicionarAoCarrinho(productCard.dataset.id);
            });

            carrinhoItensEl.addEventListener('click', (e) => {
                const target = e.target.closest('button');
                if (!target) return;
                const produtoId = target.dataset.id;
                if (!produtoId) return;
                if (target.classList.contains('add-btn-carrinho')) adicionarAoCarrinho(produtoId);
                if (target.classList.contains('remove-btn')) removerDoCarrinho(produtoId);
            });
            
            fecharModalBtn.addEventListener('click', () => {
                carrinho = [];
                renderizarCarrinho();
                modalSucessoEl.classList.add('hidden');
                mainContent.style.display = 'none';
                welcomeScreen.classList.remove('hidden');
                confirmationForm.reset();
            });
            
            initTotem();
        });
    </script>
</body>
</html>
