<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Meus Vales - BoraRangar</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .month-card { cursor: pointer; transition: transform 0.2s ease, box-shadow 0.2s ease; }
        .month-card:hover { transform: translateY(-4px); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); }
    </style>
</head>
<body class="bg-slate-100 min-h-screen">

    <div id="app-content" class="hidden">
        <header class="bg-white shadow-md">
            <div class="max-w-4xl mx-auto p-4 flex justify-between items-center">
                <h1 id="header-title" class="text-2xl font-bold text-slate-800">Meus Vales e Adiantamentos</h1>
                <a href="dashboard.html" class="bg-slate-200 hover:bg-slate-300 text-slate-800 font-bold py-2 px-4 rounded-lg">Voltar ao Painel</a>
            </div>
        </header>

        <main class="max-w-4xl mx-auto p-4 md:p-8">
            <section class="bg-white shadow-md rounded-lg">
                
                <div id="view-summary">
                    <h2 class="text-xl font-bold text-slate-700 p-4 border-b">Resumo por Mês</h2>
                    <div id="loading-summary" class="text-center p-6 text-slate-500"><p>Carregando...</p></div>
                    <div id="summary-list" class="divide-y divide-slate-200">
                        </div>
                </div>

                <div id="view-details" class="hidden">
                    <div class="p-4 border-b flex justify-between items-center">
                        <h2 id="details-title" class="text-xl font-bold text-slate-700">Detalhes</h2>
                        <button id="btn-back-to-summary" class="text-sm text-blue-600 hover:underline">&larr; Voltar</button>
                    </div>
                    <div id="details-list"> 
                        </div>
                    <div class="p-4 bg-slate-50 font-bold text-lg text-slate-800 flex justify-between rounded-b-lg">
                        <span>Total do Mês:</span>
                        <span id="details-total" class="text-green-600">R$ 0,00</span>
                    </div>
                </div>

            </section>
        </main>
    </div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    // Seletores (sem alteração)
    const appContent = document.getElementById('app-content');
    const viewSummary = document.getElementById('view-summary');
    const viewDetails = document.getElementById('view-details');
    const loadingSummary = document.getElementById('loading-summary');
    const summaryList = document.getElementById('summary-list');
    const detailsTitle = document.getElementById('details-title');
    const detailsList = document.getElementById('details-list');
    const detailsTotal = document.getElementById('details-total');
    const btnBackToSummary = document.getElementById('btn-back-to-summary');

    let appInitialized = false;
    let allValesData = []; 
    const mesesDoAno = ["Janeiro", "Fevereiro", "Março", "Abril", "Maio", "Junho", "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"];
    
    // --- FUNÇÕES PRINCIPAIS ---

    function initializeApp() {
        if (appInitialized) return;
        appInitialized = true;
        appContent.classList.remove('hidden');
        
        btnBackToSummary.addEventListener('click', showSummaryView);
        summaryList.addEventListener('click', (e) => {
            const monthCard = e.target.closest('.month-card');
            if (monthCard) {
                const monthKey = monthCard.dataset.monthKey;
                showDetailsView(monthKey);
            }
        });
        
        fetchMeusVales();
    }

    async function fetchMeusVales() {
        showSummaryView(); 
        loadingSummary.style.display = 'block';
        summaryList.innerHTML = '';
        try {
            const response = await fetch('/vales_api.php', { credentials: 'include' });
            if (!response.ok) {
                if(response.status === 403) window.location.href = '/portal-rh/index.html';
                throw new Error('Falha ao buscar seus lançamentos');
            }
            allValesData = await response.json();
            renderSummary(allValesData);
        } catch (error) {
            console.error("Erro fetchMeusVales:", error);
            loadingSummary.innerHTML = `<p class="text-red-500">${error.message}</p>`;
        }
    }

    function renderSummary(vales) {
        if (!Array.isArray(vales) || vales.length === 0) {
            loadingSummary.innerHTML = '<p class="text-slate-500 text-center p-6">Nenhum lançamento encontrado no seu nome.</p>';
            return;
        }

        const valesPorMes = vales.reduce((acc, vale) => {
            const mesKey = vale.mes_referencia.substring(0, 7); 
            if (!acc[mesKey]) {
                acc[mesKey] = { total: 0, entries: [] };
            }
            acc[mesKey].total += parseFloat(vale.valor);
            acc[mesKey].entries.push(vale);
            return acc;
        }, {});

        const mesesOrdenados = Object.keys(valesPorMes).sort().reverse();
        
        loadingSummary.style.display = 'none';
        summaryList.innerHTML = ''; 

        mesesOrdenados.forEach(mesKey => {
            const mesData = valesPorMes[mesKey];
            const [ano, mes] = mesKey.split('-');
            const mesNome = mesesDoAno[parseInt(mes, 10) - 1];
            const totalFmt = mesData.total.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
            
            summaryList.innerHTML += `
                <div class="month-card p-4 flex justify-between items-center" data-month-key="${mesKey}">
                    <div>
                        <p class="font-bold text-lg text-slate-800">${mesNome} / ${ano}</p>
                        <p class="text-sm text-slate-500">${mesData.entries.length} lançamento(s)</p>
                    </div>
                    <div class="text-right">
                        <p class="font-bold text-lg text-green-600">${totalFmt}</p>
                        <p class="text-sm text-slate-500">Total no Mês</p>
                    </div>
                </div>
            `;
        });
    }
    
    function formatLocalDate(dateString) {
        const [datePart] = dateString.split(' ');
        const [ano, mes, dia] = datePart.split('-');
        return `${dia}/${mes}/${ano}`;
    }

    /**
     * ATUALIZADO: Mostra a TELA 2 com layout de labels
     */
    function showDetailsView(monthKey) {
        // 1. Agrupa os dados
        const valesPorMes = allValesData.reduce((acc, vale) => {
            const key = vale.mes_referencia.substring(0, 7);
            if (!acc[key]) {
                acc[key] = { total: 0, entries: [] };
            }
            acc[key].total += parseFloat(vale.valor);
            acc[key].entries.push(vale);
            return acc;
        }, {});
        
        const mesData = valesPorMes[monthKey];
        if (!mesData) return; 

        // 2. Atualiza os títulos e totais
        const [ano, mes] = monthKey.split('-');
        const mesNome = mesesDoAno[parseInt(mes, 10) - 1];
        detailsTitle.textContent = `Detalhes de ${mesNome} / ${ano}`;
        detailsTotal.textContent = mesData.total.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
        
        // 3. Renderiza a lista de lançamentos
        detailsList.innerHTML = '';
        mesData.entries.sort((a, b) => new Date(a.data_lancamento) - new Date(b.data_lancamento)); 
        
        mesData.entries.forEach(vale => {
            const dataLancamentoFmt = formatLocalDate(vale.data_lancamento);
            const valorFmt = parseFloat(vale.valor).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
            
            // *** CORREÇÃO DE LAYOUT APLICADA AQUI ***
            // Agora usa um layout com labels (Descrição, Data, Valor)
            detailsList.innerHTML += `
                <div class="p-4 space-y-2 border-b border-slate-100 last:border-b-0">
                    <div class="flex justify-between items-baseline">
                        <span class="text-sm font-medium text-slate-500">Descrição:</span>
                        <span class="font-semibold text-slate-800 text-right">${vale.descricao || '(Sem descrição)'}</span>
                    </div>
                    <div class="flex justify-between items-baseline">
                        <span class="text-sm font-medium text-slate-500">Data:</span>
                        <span class="text-sm text-slate-700">${dataLancamentoFmt}</span>
                    </div>
                    <div class="flex justify-between items-baseline">
                        <span class="text-sm font-medium text-slate-500">Valor:</span>
                        <span class="font-bold text-lg text-green-600">${valorFmt}</span>
                    </div>
                </div>
            `;
            // *** FIM DA CORREÇÃO ***
        });
        
        // 4. Troca as telas
        viewSummary.classList.add('hidden');
        viewDetails.classList.remove('hidden');
    }

    function showSummaryView() {
        viewSummary.classList.remove('hidden');
        viewDetails.classList.add('hidden');
    }

    // --- Verificação de Sessão Inicial ---
    fetch('/usuario_api.php', { credentials: 'include' })
        .then(res => { 
            if (res.ok) { 
                initializeApp(); 
            } else { 
                window.location.href = '/portal-rh/index.html'; 
            } 
        })
        .catch(err => { 
            console.error("Erro na verificação inicial:", err);
            window.location.href = '/portal-rh/index.html'; 
        });
});
</script>

</body>
</html>
