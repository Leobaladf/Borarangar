<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestão de Vales - BoraRangar</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        input[type="month"]::-webkit-calendar-picker-indicator {
            cursor: pointer;
        }
    </style>
</head>
<body class="bg-slate-100 min-h-screen">

    <div id="app-content" class="hidden">
        <header class="bg-white shadow-md">
            <div class="max-w-7xl mx-auto p-4 flex justify-between items-center">
                <h1 class="text-2xl font-bold text-slate-800">Gestão de Vales e Adiantamentos</h1>
                <a href="dashboard.html" class="bg-slate-200 hover:bg-slate-300 text-slate-800 font-bold py-2 px-4 rounded-lg">Voltar ao Painel</a>
            </div>
        </header>

        <main class="max-w-7xl mx-auto p-4 md:p-8 grid grid-cols-1 lg:grid-cols-3 gap-8">
            
            <section class="lg:col-span-1 bg-white shadow-md rounded-lg p-6 h-fit">
                <h2 class="text-xl font-bold text-slate-700 mb-4">Lançar Novo Vale</h2>
                <form id="add-vale-form" class="space-y-4">
                    <div>
                        <label for="select-funcionario" class="block text-sm font-medium text-slate-600">Funcionário</label>
                        <select id="select-funcionario" name="usuario_id" required class="mt-1 block w-full p-2 border border-slate-300 rounded-md bg-white">
                            <option value="">Carregando...</option>
                        </select>
                    </div>
                    <div>
                        <label for="input-mes" class="block text-sm font-medium text-slate-600">Mês de Referência</label>
                        <input type="month" id="input-mes" name="mes_referencia" required class="mt-1 block w-full p-2 border border-slate-300 rounded-md">
                    </div>
                    <div>
                        <label for="input-valor" class="block text-sm font-medium text-slate-600">Valor (R$)</label>
                        <input type="number" id="input-valor" name="valor" step="0.01" min="0.01" placeholder="Ex: 50.00" required class="mt-1 block w-full p-2 border border-slate-300 rounded-md">
                    </div>
                    <div>
                        <label for="input-descricao" class="block text-sm font-medium text-slate-600">Descrição</label>
                        <input type="text" id="input-descricao" name="descricao" placeholder="Ex: Vale-Transporte" required class="mt-1 block w-full p-2 border border-slate-300 rounded-md">
                    </div>
                    
                    <button type="submit" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg">Lançar</button>
                    <p id="form-message" class="text-sm h-5 mt-2"></p>
                </form>
            </section>

            <section class="lg:col-span-2 bg-white shadow-md rounded-lg">
                <h2 class="text-xl font-bold text-slate-700 p-4 border-b">Histórico de Lançamentos</h2>
                <div id="loading-vales" class="text-center p-6 text-slate-500"><p>Carregando...</p></div>
                <div id="vales-list" class="divide-y divide-slate-200">
                    </div>
            </section>
        </main>
    </div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    // Seletores
    const appContent = document.getElementById('app-content');
    const addValeForm = document.getElementById('add-vale-form');
    const selectFuncionario = document.getElementById('select-funcionario');
    const inputMes = document.getElementById('input-mes');
    const formMessage = document.getElementById('form-message');
    const loadingVales = document.getElementById('loading-vales');
    const valesListDiv = document.getElementById('vales-list');

    let appInitialized = false;

    // --- FUNÇÕES PRINCIPAIS ---

    function initializeApp() {
        if (appInitialized) return;
        appInitialized = true;
        appContent.classList.remove('hidden');

        // Seta o mês atual como padrão no formulário
        const hoje = new Date();
        const ano = hoje.getFullYear();
        const mes = (hoje.getMonth() + 1).toString().padStart(2, '0');
        inputMes.value = `${ano}-${mes}`;

        // Carrega os dados iniciais
        fetchFuncionarios();
        fetchVales();

        // Listeners
        addValeForm.addEventListener('submit', handleFormSubmit);
        valesListDiv.addEventListener('click', handleListClick);
    }

    /**
     * Busca os funcionários do restaurante para popular o <select>
     */
    async function fetchFuncionarios() {
        try {
            // Usamos a 'usuario_api.php' que já existe!
            const response = await fetch('/usuario_api.php?action=get_my_employees', { credentials: 'include' });
            if (!response.ok) throw new Error('Falha ao buscar funcionários');
            
            const funcionarios = await response.json();
            
            selectFuncionario.innerHTML = '<option value="">Selecione um funcionário...</option>';
            if (Array.isArray(funcionarios)) {
                funcionarios.forEach(func => {
                    selectFuncionario.innerHTML += `<option value="${func.id}">${func.nome}</option>`;
                });
            }
        } catch (error) {
            console.error("Erro fetchFuncionarios:", error);
            selectFuncionario.innerHTML = '<option value="">Erro ao carregar funcionários</option>';
        }
    }

    /**
     * Busca os vales já lançados
     */
    async function fetchVales() {
        loadingVales.style.display = 'block';
        valesListDiv.innerHTML = '';
        try {
            // *** CORREÇÃO APLICADA AQUI ***
            // Removido o '/api' do caminho
            const response = await fetch('/vales_api.php', { credentials: 'include' });
            if (!response.ok) throw new Error('Falha ao buscar lançamentos');

            const vales = await response.json();
            renderVales(vales);

        } catch (error) {
            console.error("Erro fetchVales:", error);
            loadingVales.innerHTML = `<p class="text-red-500">${error.message}</p>`;
        }
    }

    /**
     * Renderiza a lista de vales na tela
     */
    function renderVales(vales) {
        if (!Array.isArray(vales)) {
             loadingVales.innerHTML = '<p class="text-red-500">Erro: Resposta inválida da API.</p>';
             return;
        }
        if (vales.length === 0) {
            loadingVales.innerHTML = '<p class="text-slate-500">Nenhum lançamento encontrado.</p>';
            return;
        }

        loadingVales.style.display = 'none';
        valesListDiv.innerHTML = ''; // Limpa a lista

        vales.forEach(vale => {
            const dataLancamento = new Date(vale.data_lancamento).toLocaleString('pt-BR');
            const [ano, mes] = vale.mes_referencia.split('-');
            const mesRefFmt = `${mes}/${ano}`;
            const valorFmt = parseFloat(vale.valor).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });

            valesListDiv.innerHTML += `
                <div class="p-4 flex justify-between items-start">
                    <div>
                        <p class="font-bold text-slate-800">${vale.usuario_nome}</p>
                        <p class="text-sm text-slate-600">${vale.descricao}</p>
                        <p class="text-sm font-semibold text-green-600">${valorFmt} <span class="text-slate-400 font-normal">(Ref: ${mesRefFmt})</span></p>
                        <p class="text-xs text-slate-400">Lançado em: ${dataLancamento}</p>
                    </div>
                    <button data-id="${vale.id}" class="delete-vale-btn text-xs bg-red-100 text-red-800 hover:bg-red-200 font-semibold py-1 px-3 rounded-md">
                        Excluir
                    </button>
                </div>
            `;
        });
    }

    /**
     * Lida com o envio do formulário de novo vale
     */
    async function handleFormSubmit(e) {
        e.preventDefault();
        formMessage.textContent = 'Salvando...';
        formMessage.className = 'text-sm h-5 mt-2 text-blue-600';

        const formData = new FormData(addValeForm);
        
        // Pega o valor do input tipo 'month' (YYYY-MM) e transforma em 'YYYY-MM-01'
        const mesReferenciaInput = formData.get('mes_referencia');
        const mesReferenciaDB = `${mesReferenciaInput}-01`; 

        const data = {
            usuario_id: formData.get('usuario_id'),
            valor: parseFloat(formData.get('valor')),
            descricao: formData.get('descricao'),
            mes_referencia: mesReferenciaDB // Envia a data formatada
        };

        try {
            // *** CORREÇÃO APLICADA AQUI ***
            // Removido o '/api' do caminho
            const response = await fetch('/vales_api.php', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data),
                credentials: 'include'
            });
            
            const result = await response.json();
            if (!response.ok) throw new Error(result.message || 'Erro desconhecido');

            formMessage.textContent = 'Lançado com sucesso!';
            formMessage.className = 'text-sm h-5 mt-2 text-green-600';
            addValeForm.reset();
            
            // Reseta o mês para o valor padrão
            const hoje = new Date();
            const ano = hoje.getFullYear();
            const mes = (hoje.getMonth() + 1).toString().padStart(2, '0');
            inputMes.value = `${ano}-${mes}`;
            
            fetchVales(); // Atualiza a lista

        } catch (error) {
            formMessage.textContent = `Erro: ${error.message}`;
            formMessage.className = 'text-sm h-5 mt-2 text-red-600';
        }
    }

    /**
     * Lida com o clique de "Excluir" na lista
     */
    async function handleListClick(e) {
        if (!e.target.classList.contains('delete-vale-btn')) return;

        const valeId = e.target.dataset.id;
        if (!confirm('Tem certeza que deseja excluir este lançamento?')) return;

        e.target.disabled = true;
        e.target.textContent = 'Excluindo...';

        try {
            // *** CORREÇÃO APLICADA AQUI ***
            // Removido o '/api' do caminho
            const response = await fetch(`/vales_api.php?id=${valeId}`, {
                method: 'DELETE',
                credentials: 'include'
            });
            
            const result = await response.json();
            if (!response.ok) throw new Error(result.message || 'Erro desconhecido');
            
            fetchVales(); // Atualiza a lista

        } catch (error) {
            alert(`Erro: ${error.message}`);
            e.target.disabled = false;
            e.target.textContent = 'Excluir';
        }
    }

    // --- Verificação de Sessão Inicial (O "Ping") ---
    fetch('/pedidos_api.php?status=ativos&limit=1', { credentials: 'include' })
        .then(res => { 
            if (res.ok) { 
                initializeApp(); 
            } else { 
                window.location.href = '/painel/index.html'; 
            } 
        })
        .catch(err => { 
            console.error("Erro na verificação inicial:", err);
            window.location.href = '/painel/index.html'; 
        });
});
</script>

</body>
</html>
