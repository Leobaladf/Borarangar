<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Horários de Funcionamento - BoraRangar</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .dia-atual { background-color: #fef9c3; /* yellow-100 */ } 
    </style>
</head>
<body class="bg-slate-100 min-h-screen">

    <div id="app-content" class="hidden">
        <header class="bg-white shadow-md">
            <div class="max-w-4xl mx-auto p-4 flex justify-between items-center">
                <h1 class="text-2xl font-bold text-slate-800">Horários de Funcionamento</h1>
                <a href="dashboard.html" class="bg-slate-200 hover:bg-slate-300 text-slate-800 font-bold py-2 px-4 rounded-lg">Voltar ao Painel</a>
            </div>
        </header>

        <main class="max-w-4xl mx-auto p-4 md:p-8">
            
            <section class="bg-white p-6 rounded-lg shadow-md mb-8">
                <h2 class="text-xl font-bold text-slate-700 mb-6 border-b pb-3">Horários Cadastrados</h2>
                <div id="loading-horarios" class="text-center p-6 text-slate-500"><p>Carregando horários...</p></div>
                <div id="horarios-list" class="hidden space-y-6">
                    </div>
            </section>

            <section class="bg-white p-6 rounded-lg shadow-md">
                <h2 class="text-xl font-bold text-slate-700 mb-4">Adicionar Novo Horário</h2>
                <form id="add-horario-form" class="grid grid-cols-1 sm:grid-cols-4 gap-4 items-end">
                    <div>
                        <label for="add-dia" class="block text-sm font-medium text-slate-600">Dia</label>
                        <select id="add-dia" name="dia_semana" required class="mt-1 block w-full p-2 border border-slate-300 rounded-md bg-white">
                            <option value="1">Segunda</option>
                            <option value="2">Terça</option>
                            <option value="3">Quarta</option>
                            <option value="4">Quinta</option>
                            <option value="5">Sexta</option>
                            <option value="6">Sábado</option>
                            <option value="0">Domingo</option>
                        </select>
                    </div>
                    <div>
                        <label for="add-abertura" class="block text-sm font-medium text-slate-600">Abertura</label>
                        <input type="time" id="add-abertura" name="abertura" required class="mt-1 block w-full p-2 border border-slate-300 rounded-md">
                    </div>
                    <div>
                        <label for="add-fechamento" class="block text-sm font-medium text-slate-600">Fechamento</label>
                        <input type="time" id="add-fechamento" name="fechamento" required class="mt-1 block w-full p-2 border border-slate-300 rounded-md">
                    </div>
                    <button type="submit" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg">Adicionar</button>
                </form>
                <p id="horario-form-message" class="text-sm h-5 mt-4"></p>
            </section>
        </main>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // Seletores (sem alteração)
        const appContent = document.getElementById('app-content');
        const loadingHorarios = document.getElementById('loading-horarios');
        const horariosListDiv = document.getElementById('horarios-list');
        const addHorarioForm = document.getElementById('add-horario-form');
        const horarioFormMessage = document.getElementById('horario-form-message');
        const diasSemana = ["Domingo", "Segunda", "Terça", "Quarta", "Quinta", "Sexta", "Sábado"];

        // Funções (sem alteração)
        function initializeApp() { /* ... */ }
        async function fetchHorarios() { /* ... */ }
        function renderHorarios(horarios) { /* ... */ }

        // Funções (do arquivo original que estavam faltando no seu upload)
        function initializeApp() {
            appContent.classList.remove('hidden');
            fetchHorarios(); 
        }
        async function fetchHorarios() {
            loadingHorarios.style.display = 'block';
            horariosListDiv.classList.add('hidden');
            horariosListDiv.innerHTML = ''; 
            try {
                const response = await fetch('/horarios_api.php', { credentials: 'include' }); // <--- CORREÇÃO APLICADA AQUI TAMBÉM
                if (response.status === 403) { window.location.href = '/painel/index.html'; return; }
                if (!response.ok) throw new Error('Falha ao buscar horários.');
                const data = await response.json(); 
                const horarios = data.horarios; 
                renderHorarios(horarios); 
            } catch (error) {
                loadingHorarios.innerHTML = `<p class="text-red-500">Erro: ${error.message}</p>`; 
                console.error("Erro detalhado:", error); 
            } finally {
                loadingHorarios.style.display = 'none';
                horariosListDiv.classList.remove('hidden');
            }
        }
        function renderHorarios(horarios) { 
            horariosListDiv.innerHTML = ''; 
            if (!Array.isArray(horarios)) {
                console.error("renderHorarios recebeu dados inválidos:", horarios);
                horariosListDiv.innerHTML = '<p class="text-red-500">Erro ao processar os horários recebidos.</p>';
                return;
            }
            const horariosPorDia = horarios.reduce((acc, horario) => {
                const dia = horario.dia_semana;
                if (!acc[dia]) { acc[dia] = []; }
                acc[dia].push(horario);
                return acc;
            }, {});
            const hoje = new Date().getDay(); 
            for (let dia = 0; dia <= 6; dia++) {
                const diaNome = diasSemana[dia];
                const horariosDoDia = horariosPorDia[dia] || [];
                const isHoje = dia === hoje;
                const diaDiv = document.createElement('div');
                diaDiv.className = `p-4 border rounded-lg ${isHoje ? 'dia-atual border-yellow-300' : 'bg-white'}`;
                let horariosHTML = `<h3 class="font-bold text-lg text-slate-800 mb-3">${diaNome} ${isHoje ? '<span class="text-xs text-yellow-600 font-normal">(Hoje)</span>' : ''}</h3>`;
                if (horariosDoDia.length === 0) {
                    horariosHTML += `<p class="text-sm text-slate-500">Fechado</p>`;
                } else {
                    horariosHTML += '<ul class="space-y-2">';
                    horariosDoDia.forEach(h => {
                        horariosHTML += `
                            <li class="flex flex-wrap items-center justify-between gap-2 text-sm border-t pt-2 first:border-t-0 first:pt-0">
                                <div class="flex items-center gap-2">
                                    <span class="font-mono font-semibold ${h.aberto ? 'text-green-600' : 'text-red-600 line-through'}">
                                        ${h.abertura} - ${h.fechamento}
                                    </span>
                                    <button data-id="${h.id}" data-status="${h.aberto ? 'false' : 'true'}" class="toggle-status-btn text-xs font-semibold py-1 px-2 rounded ${h.aberto ? 'bg-yellow-100 text-yellow-800 hover:bg-yellow-200' : 'bg-green-100 text-green-800 hover:bg-green-200'}">
                                        ${h.aberto ? 'Desativar' : 'Ativar'}
                                    </button>
                                </div>
                                <button data-id="${h.id}" class="delete-horario-btn text-xs bg-red-100 text-red-800 hover:bg-red-200 font-semibold py-1 px-3 rounded-md">
                                    Excluir
                                </button>
                            </li>
                        `;
                    });
                    horariosHTML += '</ul>';
                }
                diaDiv.innerHTML = horariosHTML;
                horariosListDiv.appendChild(diaDiv);
            }
        }

        // Listeners (sem alteração)
        addHorarioForm.addEventListener('submit', async (e) => { /* ... */ });
        horariosListDiv.addEventListener('click', async (e) => { /* ... */ });
        
        // Listeners (do arquivo original que estavam faltando no seu upload)
        addHorarioForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            horarioFormMessage.textContent = 'Salvando...';
            horarioFormMessage.className = 'text-sm h-5 mt-4 text-blue-600';
            const formData = new FormData(addHorarioForm);
            const data = { dia_semana: formData.get('dia_semana'), abertura: formData.get('abertura'), fechamento: formData.get('fechamento'), aberto: true };
            try {
                const response = await fetch('/horarios_api.php', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data), credentials: 'include' }); // <--- CORREÇÃO APLICADA AQUI TAMBÉM
                const result = await response.json();
                if (!response.ok) throw new Error(result.message || 'Erro desconhecido.');
                horarioFormMessage.textContent = 'Horário adicionado!';
                horarioFormMessage.className = 'text-sm h-5 mt-4 text-green-600';
                addHorarioForm.reset();
                fetchHorarios(); 
                 setTimeout(() => { horarioFormMessage.textContent = ''; }, 3000);
            } catch (error) {
                horarioFormMessage.textContent = `Erro: ${error.message}`;
                horarioFormMessage.className = 'text-sm h-5 mt-4 text-red-600';
            }
        });
        horariosListDiv.addEventListener('click', async (e) => {
            const target = e.target;
            if (target.classList.contains('delete-horario-btn')) {
                const horarioId = target.dataset.id;
                if (confirm(`Tem certeza que deseja excluir este horário?`)) {
                    try {
                        const response = await fetch(`/horarios_api.php?id=${horarioId}`, { method: 'DELETE', credentials: 'include' }); // <--- CORREÇÃO APLICADA AQUI TAMBÉM
                        const result = await response.json();
                        if (!response.ok) throw new Error(result.message || 'Erro ao excluir.');
                        fetchHorarios(); 
                    } catch (error) { alert(`Erro: ${error.message}`); }
                }
            }
            if (target.classList.contains('toggle-status-btn')) {
                const horarioId = target.dataset.id;
                const novoStatusAberto = target.dataset.status === 'true'; 
                target.disabled = true; 
                target.textContent = 'Salvando...';
                try {
                    const response = await fetch(`/horarios_api.php?id=${horarioId}`, { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ aberto: novoStatusAberto }), credentials: 'include' }); // <--- CORREÇÃO APLICADA AQUI TAMBÉM
                     const result = await response.json();
                     if (!response.ok) throw new Error(result.message || 'Erro ao atualizar status.');
                     fetchHorarios(); 
                } catch (error) { 
                     alert(`Erro: ${error.message}`); 
                     target.disabled = false; 
                }
            }
        });

        // ========================================================
        // ### CORREÇÃO "CHROME VS EDGE" APLICADA AQUI ###
        // ========================================================
        fetch('/pedidos_api.php?status=ativos&limit=1', { credentials: 'include' }) 
            .then(res => { 
                if (res.ok) { 
                    initializeApp(); 
                } else { 
                    window.location.href = '/painel/index.html'; 
                } 
            })
            .catch(err => { 
                console.error("Erro na verificação inicial:", err);
                window.location.href = '/painel/index.html'; 
            });
    });
    </script>
</body>
</html>
