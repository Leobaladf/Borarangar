<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Configurações de Entrega - BoraRangar</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Estilo para item inativo (opcional) */
        .inativo { opacity: 0.6; text-decoration: line-through; }
    </style>
</head>
<body class="bg-slate-100 min-h-screen">

    <div id="app-content" class="hidden">
        <header class="bg-white shadow-md">
            <div class="max-w-4xl mx-auto p-4 flex justify-between items-center">
                <h1 class="text-2xl font-bold text-slate-800">Configurações de Entrega</h1>
                <a href="dashboard.html" class="bg-slate-200 hover:bg-slate-300 text-slate-800 font-bold py-2 px-4 rounded-lg">Voltar ao Painel</a>
            </div>
        </header>

        <main class="max-w-4xl mx-auto p-4 md:p-8">

            <section class="bg-white p-6 rounded-lg shadow-md mb-8">
                <h2 class="text-xl font-bold text-slate-700 mb-4">Configurações Gerais</h2>
                <form id="config-geral-form" class="space-y-4">
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div>
                            <label for="pedido-minimo" class="block text-sm font-medium text-slate-600">Pedido Mínimo para Delivery (R$)</label>
                            <input type="number" id="pedido-minimo" name="pedido_minimo" required step="0.01" min="0" placeholder="Ex: 15.00" class="mt-1 block w-full p-2 border border-slate-300 rounded-md">
                            <small class="text-slate-500">Deixe 0,00 para não exigir valor mínimo.</small>
                        </div>
                        <div>
                            <label for="taxa-embalagem" class="block text-sm font-medium text-slate-600">Taxa de Embalagem (R$)</label>
                            <input type="number" id="taxa-embalagem" name="taxa_embalagem" required step="0.01" min="0" placeholder="Ex: 2.00" class="mt-1 block w-full p-2 border border-slate-300 rounded-md">
                            <small class="text-slate-500">Deixe 0,00 para não cobrar.</small>
                        </div>
                    </div>
                    <button type="submit" class="w-full sm:w-auto bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg">Salvar Configurações</button>
                </form>
                <p id="config-form-message" class="text-sm h-5 mt-4"></p>
            </section>
            
            <section class="bg-white p-6 rounded-lg shadow-md mb-8">
                <h2 class="text-xl font-bold text-slate-700 mb-4">Adicionar Novo Bairro/Taxa</h2>
                <form id="add-taxa-form" class="grid grid-cols-1 sm:grid-cols-3 gap-4 items-end">
                    <div class="sm:col-span-2">
                        <label for="add-bairro" class="block text-sm font-medium text-slate-600">Nome do Bairro</label>
                        <input type="text" id="add-bairro" name="bairro" required placeholder="Ex: Centro" class="mt-1 block w-full p-2 border border-slate-300 rounded-md">
                    </div>
                    <div>
                        <label for="add-taxa" class="block text-sm font-medium text-slate-600">Taxa (R$)</label>
                        <input type="number" id="add-taxa" name="taxa" required step="0.01" min="0" placeholder="Ex: 5.00" class="mt-1 block w-full p-2 border border-slate-300 rounded-md">
                    </div>
                    <button type="submit" class="sm:col-span-3 w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg">Adicionar Taxa</Ebut>
                </form>
                <p id="taxa-form-message" class="text-sm h-5 mt-4"></p>
            </section>

             <section class="bg-white shadow-md rounded-lg">
                <h2 class="text-xl font-bold text-slate-700 p-4 border-b">Bairros e Taxas Cadastrados</h2>
                <div id="loading-taxas" class="text-center p-6 text-slate-500">
                    <p>Carregando taxas...</p>
                </div>
                <div id="taxas-list" class="divide-y divide-slate-200">
                    </div>
            </section>

        </main>
    </div>

    <div id="edit-taxa-modal" class="hidden fixed inset-0 bg-black/60 backdrop-blur-sm z-50 flex items-center justify-center p-4">
        <div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-md">
            <h2 class="text-xl font-bold text-slate-700 mb-4">Editar Taxa</h2>
            <form id="edit-taxa-form">
                <input type="hidden" id="edit-taxa-id">
                <div class="mb-4">
                    <label for="edit-bairro" class="block text-sm font-medium text-slate-600">Nome do Bairro</label>
                    <input type="text" id="edit-bairro" name="bairro" required class="mt-1 block w-full p-2 border border-slate-300 rounded-md">
                </div>
                <div class="mb-4">
                    <label for="edit-taxa" class="block text-sm font-medium text-slate-600">Taxa (R$)</label>
                    <input type="number" id="edit-taxa" name="taxa" required step="0.01" min="0" class="mt-1 block w-full p-2 border border-slate-300 rounded-md">
                </div>
                <p id="edit-taxa-message" class="text-sm h-5 mb-4"></p>
                <div class="flex justify-end gap-4 mt-6">
                    <button type="button" class="btn-close-modal bg-slate-200 py-2 px-4 rounded-lg">Cancelar</button>
                    <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg">Salvar Alterações</button>
                </div>
            </form>
        </div>
    </div>
<script>
    document.addEventListener('DOMContentLoaded', () => {
        const appContent = document.getElementById('app-content');
        const loadingTaxas = document.getElementById('loading-taxas');
        const taxasListDiv = document.getElementById('taxas-list');
        const addTaxaForm = document.getElementById('add-taxa-form');
        const taxaFormMessage = document.getElementById('taxa-form-message');
        const editTaxaModal = document.getElementById('edit-taxa-modal');
        const editTaxaForm = document.getElementById('edit-taxa-form');
        const editTaxaMessage = document.getElementById('edit-taxa-message');
        const closeButtons = document.querySelectorAll('.btn-close-modal');

        // --- Novos Seletores ---
        const configGeralForm = document.getElementById('config-geral-form');
        const pedidoMinimoInput = document.getElementById('pedido-minimo');
        const taxaEmbalagemInput = document.getElementById('taxa-embalagem'); // <-- NOVO
        const configFormMessage = document.getElementById('config-form-message');

        let currentTaxas = []; 

        function initializeApp() {
            appContent.classList.remove('hidden');
            fetchTaxas(); 
        }

        async function fetchTaxas() {
            loadingTaxas.style.display = 'block';
            taxasListDiv.innerHTML = ''; 
            try {
                const response = await fetch('/taxas_api.php', { credentials: 'include' });
                if (response.status === 403) { window.location.href = '/painel/index.html'; return; }
                if (!response.ok) throw new Error('Falha ao buscar taxas.');
                
                // --- ATUALIZADO PARA RECEBER O OBJETO COMPLETO ---
                const data = await response.json(); 
                currentTaxas = data.taxas; 
                
                pedidoMinimoInput.value = data.pedido_minimo.toFixed(2);
                taxaEmbalagemInput.value = data.taxa_embalagem.toFixed(2); // <-- NOVO
                
                renderTaxas(currentTaxas);

            } catch (error) {
                loadingTaxas.innerHTML = `<p class="text-red-500">${error.message}</p>`;
            } finally {
                loadingTaxas.style.display = 'none';
            }
        }
        
        // (RenderTaxas não muda)
        function renderTaxas(taxas) {
            taxasListDiv.innerHTML = ''; 
            if (taxas.length === 0) {
                 taxasListDiv.innerHTML = '<p class="p-4 text-slate-500 text-center">Nenhuma taxa de entrega cadastrada.</p>';
                 return;
            }
            taxas.forEach(t => {
                const taxaDiv = document.createElement('div');
                taxaDiv.className = `p-4 flex flex-col sm:flex-row justify-between sm:items-center gap-2 ${!t.ativo ? 'inativo' : ''}`;
                taxaDiv.innerHTML = `
                    <div class="flex-grow">
                        <p class="font-bold text-slate-800">${t.bairro}</p>
                        <p class="text-sm font-semibold text-green-600">R$ ${t.taxa.toFixed(2).replace('.', ',')}</p>
                    </div>
                    <div class="flex items-center gap-2 flex-shrink-0">
                         <button data-id="${t.id}" data-status="${t.ativo ? 'false' : 'true'}" class="toggle-taxa-status-btn text-xs font-semibold py-1 px-2 rounded ${t.ativo ? 'bg-yellow-100 text-yellow-800 hover:bg-yellow-200' : 'bg-green-100 text-green-800 hover:bg-green-200'}">
                             ${t.ativo ? 'Desativar' : 'Ativar'}
                         </button>
                         <button data-id="${t.id}" class="edit-taxa-btn text-xs bg-blue-100 text-blue-800 hover:bg-blue-200 font-semibold py-1 px-3 rounded-md">
                             Editar
                         </button>
                         <button data-id="${t.id}" class="delete-taxa-btn text-xs bg-red-100 text-red-800 hover:bg-red-200 font-semibold py-1 px-3 rounded-md">
                             Excluir
                         </button>
                    </div>
                `;
                taxasListDiv.appendChild(taxaDiv);
            });
        }

        // --- Handlers de Eventos ---

        // (addTaxaForm não muda)
        addTaxaForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            taxaFormMessage.textContent = 'Salvando...';
            taxaFormMessage.className = 'text-sm h-5 mt-4 text-blue-600';
            const formData = new FormData(addTaxaForm);
            const data = { bairro: formData.get('bairro'), taxa: parseFloat(formData.get('taxa')) };
            try {
                const response = await fetch('/taxas_api.php', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data), credentials: 'include' });
                const result = await response.json();
                if (!response.ok) throw new Error(result.message || 'Erro desconhecido.');
                taxaFormMessage.textContent = 'Taxa adicionada!';
                taxaFormMessage.className = 'text-sm h-5 mt-4 text-green-600';
                addTaxaForm.reset();
                fetchTaxas(); 
                 setTimeout(() => { taxaFormMessage.textContent = ''; }, 3000);
            } catch (error) {
                taxaFormMessage.textContent = `Erro: ${error.message}`;
                taxaFormMessage.className = 'text-sm h-5 mt-4 text-red-600';
            }
        });

        // --- LISTENER ATUALIZADO: Salvar Configs Gerais ---
        configGeralForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            configFormMessage.textContent = 'Salvando...';
            configFormMessage.className = 'text-sm h-5 mt-4 text-blue-600';

            const data = {
                pedido_minimo: parseFloat(pedidoMinimoInput.value),
                taxa_embalagem: parseFloat(taxaEmbalagemInput.value) // <-- NOVO
            };

            try {
                // Faz um PUT sem ?id=, que a nossa API agora entende como "atualizar config"
                const response = await fetch('/taxas_api.php', {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data),
                    credentials: 'include' 
                });
                const result = await response.json();
                if (!response.ok) throw new Error(result.message || 'Erro desconhecido.');

                configFormMessage.textContent = result.message || 'Salvo!';
                configFormMessage.className = 'text-sm h-5 mt-4 text-green-600';
                setTimeout(() => { configFormMessage.textContent = ''; }, 3000);

            } catch (error) {
                configFormMessage.textContent = `Erro: ${error.message}`;
                configFormMessage.className = 'text-sm h-5 mt-4 text-red-600';
            }
        });


        // (O resto dos listeners não muda)
        taxasListDiv.addEventListener('click', async (e) => {
            const target = e.target;
            if (target.classList.contains('delete-taxa-btn')) {
                const taxaId = target.dataset.id;
                if (confirm(`Tem certeza que deseja excluir esta taxa de entrega?`)) {
                    try {
                        const response = await fetch(`/taxas_api.php?id=${taxaId}`, { method: 'DELETE', credentials: 'include' });
                        const result = await response.json();
                        if (!response.ok) throw new Error(result.message || 'Erro ao excluir.');
                        fetchTaxas(); 
                    } catch (error) { alert(`Erro: ${error.message}`); }
                }
            }
            if (target.classList.contains('toggle-taxa-status-btn')) {
                const taxaId = target.dataset.id;
                const novoStatusAtivo = target.dataset.status === 'true'; 
                target.disabled = true; target.textContent = '...';
                try {
                    const response = await fetch(`/taxas_api.php?id=${taxaId}`, { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ ativo: novoStatusAtivo }), credentials: 'include' });
                     const result = await response.json();
                     if (!response.ok) throw new Error(result.message || 'Erro ao atualizar status.');
                     fetchTaxas(); 
                } catch (error) { 
                     alert(`Erro: ${error.message}`); 
                     fetchTaxas(); 
                }
            }
            if (target.classList.contains('edit-taxa-btn')) {
                const taxaId = target.dataset.id;
                const taxaParaEditar = currentTaxas.find(t => t.id == taxaId);
                if (taxaParaEditar) {
                     document.getElementById('edit-taxa-id').value = taxaParaEditar.id;
                     document.getElementById('edit-bairro').value = taxaParaEditar.bairro;
                     document.getElementById('edit-taxa').value = taxaParaEditar.taxa.toFixed(2);
                     editTaxaMessage.textContent = ''; 
                     editTaxaModal.classList.remove('hidden');
                }
            }
        });
        editTaxaForm.addEventListener('submit', async (e) => {
             e.preventDefault();
             editTaxaMessage.textContent = 'Salvando...';
             editTaxaMessage.className = 'text-sm h-5 mb-4 text-blue-600';
             const taxaId = document.getElementById('edit-taxa-id').value;
             const data = { bairro: document.getElementById('edit-bairro').value, taxa: parseFloat(document.getElementById('edit-taxa').value) };
             try {
                const response = await fetch(`/taxas_api.php?id=${taxaId}`, { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data), credentials: 'include' });
                const result = await response.json();
                if (!response.ok) throw new Error(result.message || 'Erro desconhecido.');
                editTaxaMessage.textContent = 'Taxa atualizada!';
                editTaxaMessage.className = 'text-sm h-5 mb-4 text-green-600';
                fetchTaxas(); 
                setTimeout(() => { 
                    editTaxaModal.classList.add('hidden'); 
                    editTaxaMessage.textContent = ''; 
                }, 1500);
            } catch (error) {
                editTaxaMessage.textContent = `Erro: ${error.message}`;
                editTaxaMessage.className = 'text-sm h-5 mb-4 text-red-600';
            }
        });
        closeButtons.forEach(button => {
            button.addEventListener('click', () => {
                editTaxaModal.classList.add('hidden');
            });
        });

        // --- Verificação de Sessão Inicial ---
        initializeApp();
    });
    </script>
</body>
</html>
