<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Avaliações dos Clientes - BoraRangar</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .star-rating { color: #f59e0b; } /* Cor da estrela (amarelo-500) */
        .star-rating .empty { color: #d1d5db; } /* Cor da estrela vazia (cinza-300) */
    </style>
</head>
<body class="bg-slate-100 min-h-screen">

    <div id="app-content" class="hidden">
        <header class="bg-white shadow-md">
            <div class="max-w-4xl mx-auto p-4 flex justify-between items-center">
                <h1 class="text-2xl font-bold text-slate-800">Avaliações dos Clientes</h1>
                <a href="dashboard.html" class="bg-slate-200 hover:bg-slate-300 text-slate-800 font-bold py-2 px-4 rounded-lg">Voltar ao Painel</a>
            </div>
        </header>

        <main class="max-w-4xl mx-auto p-4 md:p-8">

            <section class="bg-white p-6 rounded-lg shadow-md mb-8">
                <h2 class="text-xl font-bold text-slate-700 mb-4">Filtros e Métricas</h2>
                
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4 items-end">
                    <div>
                        <label for="filtro-data-inicio" class="block text-sm font-medium text-slate-600">Data Inicial</label>
                        <input type="date" id="filtro-data-inicio" class="mt-1 block w-full p-2 border border-slate-300 rounded-md">
                    </div>
                    <div>
                        <label for="filtro-data-fim" class="block text-sm font-medium text-slate-600">Data Final</label>
                        <input type="date" id="filtro-data-fim" class="mt-1 block w-full p-2 border border-slate-300 rounded-md">
                    </div>
                    <div>
                        <label for="filtro-rating" class="block text-sm font-medium text-slate-600">Filtrar por Nota</label>
                        <select id="filtro-rating" class="mt-1 block w-full p-2 border border-slate-300 rounded-md bg-white">
                            <option value="">Todas as notas</option>
                            <option value="5">★★★★★ (5 estrelas)</option>
                            <option value="4">★★★★☆ (4 estrelas)</option>
                            <option value="3">★★★☆☆ (3 estrelas)</option>
                            <option value="2">★★☆☆☆ (2 estrelas)</option>
                            <option value="1">★☆☆☆☆ (1 estrela)</option>
                        </select>
                    </div>
                    
                    <button id="filtro-btn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg">Filtrar</button>
                </div>
                
                <div class="grid grid-cols-2 gap-4 mt-6 pt-4 border-t">
                    <div class="bg-slate-100 p-4 rounded-lg text-center">
                        <p class="text-sm font-semibold text-slate-500">Total de Avaliações (Filtro)</p>
                        <p id="total-avaliacoes" class="text-3xl font-bold text-slate-800">--</p>
                    </div>
                    <div class="bg-slate-100 p-4 rounded-lg text-center">
                        <p class="text-sm font-semibold text-slate-500">Média Geral (Filtro)</p>
                        <p id="media-geral" class="text-3xl font-bold text-yellow-500">--</p>
                    </div>
                </div>
            </section>
            
            <section class="bg-white p-6 rounded-lg shadow-md">
                <div id="loading" class="text-center p-6 text-slate-500">
                    <p>Carregando avaliações...</p>
                </div>
                <div id="avaliacoes-list" class="space-y-6">
                    </div>
            </section>

        </main>
    </div>
<script>
    document.addEventListener('DOMContentLoaded', () => {
        const appContent = document.getElementById('app-content');
        const loadingDiv = document.getElementById('loading');
        const avaliacoesListDiv = document.getElementById('avaliacoes-list');

        // --- Novos Seletores ---
        const filtroDataInicio = document.getElementById('filtro-data-inicio');
        const filtroDataFim = document.getElementById('filtro-data-fim');
        const filtroRating = document.getElementById('filtro-rating');
        const filtroBtn = document.getElementById('filtro-btn');
        const totalAvaliacoesEl = document.getElementById('total-avaliacoes');
        const mediaGeralEl = document.getElementById('media-geral');
        
        // --- Seta as datas padrão (Hoje) ---
        const hoje = new Date().toISOString().split('T')[0];
        filtroDataInicio.value = hoje;
        filtroDataFim.value = hoje;

        // --- Adiciona Listener ao Botão Filtrar ---
        filtroBtn.addEventListener('click', fetchAvaliacoes);

        async function fetchAvaliacoes() {
            loadingDiv.style.display = 'block';
            avaliacoesListDiv.innerHTML = '';
            
            // --- Atualizado para ler os filtros ---
            const rating = filtroRating.value;
            const dataInicio = filtroDataInicio.value;
            const dataFim = filtroDataFim.value;
            
            const url = new URL('/avaliacoes_api.php', window.location.origin);
            if (rating) {
                url.searchParams.append('rating', rating);
            }
            if (dataInicio) {
                url.searchParams.append('data_inicio', dataInicio);
            }
            if (dataFim) {
                url.searchParams.append('data_fim', dataFim);
            }
            
            try {
                const response = await fetch(url.toString(), {
                    credentials: 'include' // Mantém a correção do "Chrome vs Edge"
                });
                
                if (response.status === 403) {
                    window.location.href = '/painel/index.html'; 
                    return;
                }
                
                if (!response.ok) {
                    throw new Error(`Falha ao buscar as avaliações (Erro: ${response.status})`);
                }
                
                const avaliacoes = await response.json();
                renderAvaliacoes(avaliacoes);

            } catch (error) {
                loadingDiv.innerHTML = `<p class="text-red-500">${error.message}</p>`;
            } finally {
                loadingDiv.style.display = 'none';
            }
        }

        function renderAvaliacoes(avaliacoes) {
            appContent.classList.remove('hidden'); 

            if (!Array.isArray(avaliacoes)) {
                 avaliacoesListDiv.innerHTML = '<p class="text-red-500 text-center">Erro: A resposta da API não foi uma lista.</p>';
                 return;
            }

            // --- Lógica das Métricas ---
            const total = avaliacoes.length;
            const media = total > 0 ? (avaliacoes.reduce((acc, a) => acc + a.rating, 0) / total) : 0;
            
            totalAvaliacoesEl.textContent = total;
            mediaGeralEl.textContent = media.toFixed(1).replace('.', ',');


            if (avaliacoes.length === 0) {
                avaliacoesListDiv.innerHTML = '<p class="text-slate-500 text-center">Nenhuma avaliação encontrada para este filtro.</p>';
                return;
            }

            // Limpa a lista antes de adicionar novos
            avaliacoesListDiv.innerHTML = '';

            avaliacoes.forEach(avaliacao => {
                // ========================================================
                // ### CORREÇÃO DA DATA APLICADA AQUI ###
                // ========================================================
                let dataFormatada = '';
                if (avaliacao.data_criacao) {
                    try {
                        dataFormatada = new Date(avaliacao.data_criacao).toLocaleString('pt-BR');
                    } catch(e) { /* data pode ser inválida ou nula */ }
                }

                const estrelasHTML = renderStars(avaliacao.rating);

                const avaliacaoCard = document.createElement('div');
                avaliacaoCard.className = 'border-t border-slate-200 pt-6 first:border-t-0 first:pt-0';
                
                avaliacaoCard.innerHTML = `
                    <div class="flex justify-between items-center mb-2">
                        <p class="font-bold text-slate-800">${avaliacao.cliente_nome || 'Cliente Anônimo'}</p>
                        <p class="text-xs text-slate-500">${dataFormatada}</p>
                    </div>
                    <div class="star-rating text-xl mb-3">
                        ${estrelasHTML}
                    </div>
                    <p class="text-slate-600 italic">"${avaliacao.comentario || 'Nenhum comentário.'}"</p>
                `;

                avaliacoesListDiv.appendChild(avaliacaoCard);
            });
        }

        function renderStars(rating) {
            if (rating === null || rating < 1) {
                return '<span class="empty">-</span>';
            }
            let stars = '';
            for (let i = 1; i <= 5; i++) {
                stars += `<span class="${i <= rating ? '' : 'empty'}">★</span>`;
            }
            return stars;
        }

        // Inicia a aplicação (carrega com filtros de hoje)
        fetchAvaliacoes();
    });
    </script>
</body>
</html>
