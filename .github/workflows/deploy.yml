name: Deploy FTP

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout código
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Configurar PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.1'
          extensions: mbstring, mysqli, fileinfo

      - name: Instalar dependências Composer
        working-directory: ./html
        run: |
          composer install --no-dev --optimize-autoloader --no-interaction

      - name: Preparar arquivos para deploy
        run: |
          echo "Preparando arquivos para deploy..."
          
          # Criar diretório temporário
          mkdir -p deploy
          
          # Copiar tudo da raiz para deploy, excluindo .git e .github
          rsync -av --exclude='.git' --exclude='.github' --exclude='deploy' --exclude='node_modules' . deploy/
          
          # Remover arquivos que não devem ir para produção
          find deploy -name "*.save" -delete
          find deploy -name "*.old" -delete
          find deploy -name "*.agada" -delete
          find deploy -name ".git*" -delete
          
          # Criar diretório uploads se necessário
          if [ -d "html/uploads" ]; then
            mkdir -p deploy/html/uploads/cardapio
          fi
          
          echo "Arquivos preparados"

      - name: Instalar sshpass
        run: |
          sudo apt-get update
          sudo apt-get install -y sshpass

      - name: Deploy via SFTP/SSH
        run: |
          DIRETORIO="${{ secrets.DIRETORIO }}"
          
          # Garantir que o diretório termine com /
          if [[ "$DIRETORIO" != */ ]]; then
            DIRETORIO="${DIRETORIO}/"
          fi
          
          # Adicionar host ao known_hosts
          ssh-keyscan -p ${{ secrets.PORTA }} ${{ secrets.HOST }} >> ~/.ssh/known_hosts 2>/dev/null || true
          
          # Criar diretório remoto se não existir
          sshpass -p "${{ secrets.SENHA }}" ssh -p ${{ secrets.PORTA }} -o StrictHostKeyChecking=no ${{ secrets.USUARIO }}@${{ secrets.HOST }} "mkdir -p ${DIRETORIO}"
          
          # Fazer deploy usando rsync via SSH com senha
          sshpass -p "${{ secrets.SENHA }}" rsync -avz --delete \
            -e "ssh -p ${{ secrets.PORTA }} -o StrictHostKeyChecking=no" \
            --exclude='.git' \
            --exclude='.github' \
            --exclude='deploy' \
            --exclude='node_modules' \
            --exclude='*.save' \
            --exclude='*.old' \
            --exclude='*.agada' \
            --exclude='.env' \
            ./deploy/ \
            ${{ secrets.USUARIO }}@${{ secrets.HOST }}:${DIRETORIO}

      - name: Notificar sucesso
        if: success()
        run: |
          echo "Deploy concluído com sucesso!"
          echo "Branch: ${{ github.ref_name }}"
          echo "Commit: ${{ github.sha }}"

      - name: Notificar falha
        if: failure()
        run: |
          echo "Deploy falhou!"
          echo "Branch: ${{ github.ref_name }}"
          exit 1

