name: Deploy FTP

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout código
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Configurar PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.1'
          extensions: mbstring, mysqli, fileinfo

      - name: Instalar dependências Composer
        working-directory: ./html
        run: |
          composer install --no-dev --optimize-autoloader --no-interaction

      - name: Preparar arquivos para deploy
        run: |
          echo "Preparando arquivos para deploy..."
          
          # Criar diretório temporário
          mkdir -p deploy
          
          # Copiar tudo da raiz para deploy, excluindo .git e .github
          rsync -av --exclude='.git' --exclude='.github' --exclude='deploy' --exclude='node_modules' . deploy/
          
          # Remover arquivos que não devem ir para produção
          find deploy -name "*.save" -delete
          find deploy -name "*.old" -delete
          find deploy -name "*.agada" -delete
          find deploy -name ".git*" -delete
          
          # Criar diretório uploads se necessário
          if [ -d "html/uploads" ]; then
            mkdir -p deploy/html/uploads/cardapio
          fi
          
          echo "Arquivos preparados"

      - name: Configurar FTP
        id: ftp-config
        run: |
          HOST="${{ secrets.HOST }}"
          PORTA="${{ secrets.PORTA }}"
          DIRETORIO="${{ secrets.DIRETORIO }}"
          
          # Garantir que o diretório termine com /
          if [[ "$DIRETORIO" != */ ]]; then
            DIRETORIO="${DIRETORIO}/"
          fi
          
          # Configurar servidor com porta se necessário
          if [[ -n "$PORTA" ]] && [[ "$PORTA" != "" ]]; then
            FTP_SERVER="${HOST}:${PORTA}"
          else
            FTP_SERVER="$HOST"
          fi
          
          echo "server=${FTP_SERVER}" >> $GITHUB_OUTPUT
          echo "server-dir=${DIRETORIO}" >> $GITHUB_OUTPUT
          echo "Servidor FTP: ${FTP_SERVER}"
          echo "Diretorio remoto: ${DIRETORIO}"

      - name: Deploy via FTP
        uses: SamKirkland/FTP-Deploy-Action@4.3.0
        with:
          server: ${{ steps.ftp-config.outputs.server }}
          username: ${{ secrets.USUARIO }}
          password: ${{ secrets.SENHA }}
          local-dir: ./deploy/
          server-dir: ${{ steps.ftp-config.outputs.server-dir }}
          exclude: |
            **/.git*
            **/.git*/**
            **/.github/**
            **/node_modules/**
            **/.env
            **/*.save
            **/*.old
            **/*.agada
            **/deploy/**

      - name: Notificar sucesso
        if: success()
        run: |
          echo "Deploy concluído com sucesso!"
          echo "Branch: ${{ github.ref_name }}"
          echo "Commit: ${{ github.sha }}"

      - name: Notificar falha
        if: failure()
        run: |
          echo "Deploy falhou!"
          echo "Branch: ${{ github.ref_name }}"
          exit 1

