name: Deploy FTP

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout código
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Configurar PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.1'
          extensions: mbstring, mysqli, fileinfo

      - name: Instalar dependências Composer
        working-directory: ./html
        run: |
          composer install --no-dev --optimize-autoloader --no-interaction

      - name: Preparar arquivos para deploy
        run: |
          echo "Preparando arquivos para deploy..."
          
          # Criar diretório temporário
          mkdir -p deploy
          
          # Copiar arquivos HTML e PHP
          cp -r html/* deploy/
          
          # Remover arquivos que não devem ir para produção
          find deploy -name "*.save" -delete
          find deploy -name "*.old" -delete
          find deploy -name "*.agada" -delete
          find deploy -name ".git*" -delete
          
          # Criar arquivo .gitkeep para uploads se necessário
          mkdir -p deploy/uploads/cardapio
          
          echo "Arquivos preparados"

      - name: Configurar host FTP com porta
        id: ftp-config
        run: |
          HOST="${{ secrets.HOST }}"
          PORTA="${{ secrets.PORTA }}"
          
          # Se a porta for diferente de 21 (padrão FTP), adicionar ao host
          if [[ -n "$PORTA" ]] && [[ "$PORTA" != "21" ]]; then
            FTP_SERVER="${HOST}:${PORTA}"
          else
            FTP_SERVER="$HOST"
          fi
          
          echo "server=${FTP_SERVER}" >> $GITHUB_OUTPUT
          echo "Servidor FTP: ${FTP_SERVER}"

      - name: Deploy via FTP
        uses: SamKirkland/FTP-Deploy-Action@4.3.0
        with:
          server: ${{ steps.ftp-config.outputs.server }}
          username: ${{ secrets.USUARIO }}
          password: ${{ secrets.SENHA }}
          local-dir: ./deploy/
          server-dir: ${{ secrets.DIRETORIO }}
          exclude: |
            **/.git*
            **/.git*/**
            **/node_modules/**
            **/.env
            **/*.save
            **/*.old
            **/*.agada
            **/composer.lock
            **/composer.json

      - name: Notificar sucesso
        if: success()
        run: |
          echo "Deploy concluído com sucesso!"
          echo "Branch: ${{ github.ref_name }}"
          echo "Commit: ${{ github.sha }}"

      - name: Notificar falha
        if: failure()
        run: |
          echo "Deploy falhou!"
          echo "Branch: ${{ github.ref_name }}"
          exit 1

